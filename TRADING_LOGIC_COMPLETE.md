# 📊 ПОЛНАЯ ЛОГИКА ТОРГОВЛИ БОТА V4.0 PRO

**Дата:** 2025-10-29  
**Версия:** Super Bot V4.0 PRO  
**Статус:** 🟢 РАБОТАЕТ НА СЕРВЕРЕ

---

## 🎯 ОСНОВНЫЕ ПАРАМЕТРЫ ТОРГОВЛИ

### 💰 Размеры и Плечо

| Параметр | Значение | Описание |
|----------|----------|----------|
| **LEVERAGE** | **5x** | Плечо маржинальной торговли |
| **TRADE_SIZE_USDT** | **5 USDT** | Размер одной позиции |
| **Максимальная позиция** | **$25** | 5 USDT × 5x = $25 на сделку |
| **MAX_OPEN_TRADES** | **3** | Максимум одновременно открытых сделок |
| **Общий капитал в работе** | **$75 max** | 3 сделки × $25 = $75 |

---

## 🛑 УПРАВЛЕНИЕ РИСКАМИ

### Stop Loss (Стоп-лосс)

| Параметр | Значение | Описание |
|----------|----------|----------|
| **STOP_LOSS_PERCENT** | **-20%** | Автоматический стоп-лосс |
| **Trailing Stop** | **Включен** | Трейлинг-стоп до безубытка |
| **Максимальный убыток** | **-$5 на сделку** | $25 × 20% = -$5 при срабатывании SL |

### Take Profit (Тейк-профит) - 6 Адаптивных Уровней

| Уровень | Прибыль | Закрытие позиции | Прибыль на уровень | Накопительно |
|---------|---------|------------------|-------------------|--------------|
| **TP1** | **+4%** | **40%** | **$0.40** | **$0.40** |
| **TP2** | **+6%** | **20%** | **$0.30** | **$0.70** |
| **TP3** | **+8%** | **20%** | **$0.40** | **$1.10** ✅ |
| **TP4** | **+10%** | **10%** | **+$0.25** | **$1.35** |
| **TP5** | **+12%** | **5%** | **+$0.15** | **$1.50** |
| **TP6** | **+15%** | **5%** | **+$0.19** | **$1.69** |

**🎯 Гарантированный минимум:** **+$1.10 (+4.4%)** при закрытии TP1+TP2+TP3  
**💰 Расчет:** $25 × 40% × 4% + $25 × 20% × 6% + $25 × 20% × 8% = $0.40 + $0.30 + $0.40 = **$1.10**

---

## 📈 ПОРОГ УВЕРЕННОСТИ И ОТКРЫТИЕ СДЕЛОК

### Минимальная уверенность

| Параметр | Значение | Описание |
|----------|----------|----------|
| **MIN_CONFIDENCE (базовый)** | **65%** ✅ | Базовый порог (повышен для строгого отбора) |
| **MIN_CONFIDENCE (адаптивный)** | **65-80%** | Адаптируется AI+ML под рыночные условия |
| **Оценка стратегии** | **0-20 баллов** | Минимальная оценка: 10+ баллов |
| **Реалистичность** | **Обязательна** | Проверка на манипуляции |

**Логика:** Если базовая уверенность ≥ 65% И оценка стратегии ≥ 10 баллов → сделка открывается  
**Почему 65%?** Учитывая мощную систему фильтров (Strategy Evaluator, RealismValidator, ManipulationDetector, MTF подтверждение, Volume Spike), базовый порог повышен для более строгого отбора только лучших сигналов.

---

## 🔍 ФОРМИРОВАНИЕ СИГНАЛА (Ensemble метод)

### 1. Базовые индикаторы (веса)

| Индикатор | Вес | Условие для BUY | Условие для SELL |
|-----------|-----|----------------|------------------|
| **EMA (9, 21, 50)** | **20%** | EMA9 > EMA21 на всех TF | EMA9 < EMA21 на всех TF |
| **RSI** | **15%** | RSI < 70 (адаптивный) | RSI > 30 (адаптивный) |
| **MACD** | **15%** | MACD > Signal | MACD < Signal |
| **Bollinger Bands** | **10%** | Цена в нижней части | Цена в верхней части |
| **Volume** | **10%** | Volume spike (>1.5x) | Volume spike |
| **ATR** | **10%** | Волатильность нормальная | Волатильность нормальная |
| **Stochastic** | **10%** | %K < 80 | %K > 20 |
| **ADX** | **10%** | ADX > 25 (сильный тренд) | ADX > 25 |

### 2. Мульти-таймфреймовый анализ (MTF)

**Обязательное подтверждение на:**
- ✅ 15m: краткосрочный сигнал
- ✅ 30m: основной анализ
- ✅ 45m: дополнительное подтверждение
- ✅ 1h: среднесрочный тренд
- ✅ 4h: долгосрочный тренд

**Если таймфреймы конфликтуют** → уверенность снижается

### 3. Расширенные индикаторы (бонусы к уверенности)

| Индикатор | Бонус | Условие |
|-----------|-------|---------|
| **Ichimoku Cloud** | **+5%** | Сигнал совпадает с направлением |
| **Fibonacci уровни** | **+3%** | Цена на ключевом уровне (38.2%, 50%, 61.8%) |
| **Support/Resistance** | **+4%** | Цена близко к уровню (<2%) |

### 4. ML/AI анализ (бонусы)

| Компонент | Бонус | Описание |
|-----------|-------|----------|
| **ML Prediction** | **+2-5%** | ML модель предсказывает движение |
| **Probability Calculator** | **Бонус** | Высокая вероятность достижения TP |
| **Strategy Evaluator** | **Обязательно ≥10** | Оценка стратегии 0-20 баллов |

### 5. Детекция манипуляций

**Проверяются:**
- ❌ Фейковые пампы → сигнал отклоняется
- ❌ Охота на стоп-лоссы → сигнал отклоняется
- ❌ Ложные пробои → сигнал отклоняется
- ❌ Свипы ликвидности → сигнал отклоняется

**Если манипуляции обнаружены** → сигнал НЕ открывается, даже если уверенность высокая

### 6. Open Interest (OI) анализ

- Аномалии объемов
- Активность крупных игроков (whales)
- Кластерный анализ

---

## 🎯 УМНЫЙ ВЫБОР МОНЕТ

### Количество анализируемых монет

| Рыночное условие | Количество монет | Логика выбора |
|-------------------|------------------|---------------|
| **BULL (бычий)** | **200** | Больше возможностей на росте |
| **BEAR (медвежий)** | **100** | Фокус только на топ монетах |
| **VOLATILE** | **150** | Средний охват |
| **NEUTRAL/NORMAL** | **145** ✅ | Стандартный анализ (ИСПОЛЬЗУЕТСЯ) |

### Фильтры отбора монет

| Критерий | Значение | Описание |
|----------|----------|----------|
| **Минимальный объем 24h** | **$1,000,000** | Только ликвидные монеты |
| **Минимальная цена** | **$0.001** | Исключаем микро-монеты |
| **Максимальная цена** | **$100,000** | Исключаем слишком дорогие |
| **Изменение 24h** | **-20% до +50%** | Исключаем экстремальные движения |
| **Формат** | **USDT пары** | Только USDT/фьючерсы |

### Исключенные символы (всегда)

```
DOGEUSDT, SHIBUSDT, PEPEUSDT, FLOKIUSDT, BONKUSDT,
WIFUSDT, BOMEUSDT, MEMEUSDT, CATUSDT, DOGWIFHATUSDT
```

---

## 💸 КОМИССИИ БИРЖИ

| Тип | Значение | Применение |
|-----|----------|------------|
| **Taker Fee** | **0.055%** | При открытии/закрытии (market orders) |
| **Maker Fee** | **0.02%** | Не используется |

### Расчет чистой прибыли

**На открытие позиции:**
- Позиция: $25
- Комиссия: $25 × 0.00055 = **$0.01375**

**На закрытие (TP1 - 40% позиции):**
- Закрываем: $25 × 40% = $10
- Комиссия: $10 × 0.00055 = **$0.0055**

**Итого комиссия на TP1:** $0.01375 + $0.0055 = **$0.01925**

**Чистая прибыль TP1:** $0.40 - $0.01925 = **$0.38075**

**Чистая прибыль (TP1+TP2+TP3):** ~**$1.08** (после всех комиссий)

✅ **Все комиссии учтены в расчетах прибыли**

---

## 🎲 ПОЛНАЯ ЛОГИКА ОТКРЫТИЯ СДЕЛКИ

### Условия ОТКРЫТИЯ (все должны быть выполнены):

1. ✅ **Уверенность ≥ 65%** (базовый порог, может адаптироваться до 80%)
2. ✅ **Оценка стратегии ≥ 10/20 баллов**
3. ✅ **Реалистичность проверена** (RealismValidator)
4. ✅ **Нет манипуляций** (ManipulationDetector)
5. ✅ **Открытых позиций < 3**
6. ✅ **Подтверждение на всех 5 таймфреймах** (15m, 30m, 45m, 1h, 4h)
7. ✅ **Volume spike обнаружен** (объем > 1.5x среднего)
8. ✅ **TP вероятности рассчитаны** (Probability Calculator)

### Бонусы к уверенности (могут повысить до 100%):

- **Ichimoku Cloud совпадение**: +5%
- **Fibonacci на ключевом уровне**: +3%
- **Support/Resistance рядом**: +4%
- **Большой объем (spike >2x)**: +3-5%
- **Сильный тренд (ADX > 30)**: +2%
- **ML Prediction высокий**: +2-5%

---

## 🔄 ЛОГИКА ЗАКРЫТИЯ ПОЗИЦИЙ

### Частичное закрытие по TP

```
При достижении TP1 (+4%):
├─ Закрывается 40% позиции
├─ Остается 60% для дальнейших TP
└─ Прибыль фиксируется: $0.40

При достижении TP2 (+6%):
├─ Закрывается еще 20% позиции
├─ Остается 40% для TP3-TP6
└─ Прибыль фиксируется: $0.30

... и так далее до TP6
```

### Полное закрытие по Stop Loss

```
При достижении SL (-20%):
├─ Закрывается 100% позиции
├─ Убыток: -$5
└─ Проверяется Auto-Reversal
```

### Trailing Stop

- Активируется когда прибыль > +5%
- Следит за максимумом прибыли
- При откате закрывает позицию на безубытке

---

## 🔄 АВТО-РЕВЕРСАЛЬНАЯ ЛОГИКА

### Условия для реверса после SL:

1. ✅ Стоп-лосс сработал (-20%)
2. ✅ **Сильный противоположный сигнал** (уверенность > 80%)
3. ✅ **Большой объем** в противоположном направлении
4. ✅ **Open Interest** показывает движение крупных игроков
5. ✅ **Нет манипуляций** (не фейковый сигнал)

**Логика:**
- Закрывается позиция по SL: -20%
- Сразу открывается противоположная позиция
- Новый Stop Loss: -20% от новой цены входа

---

## 🧠 УНИВЕРСАЛЬНАЯ ЛОГИКА ОБУЧЕНИЯ

### ✅ Что делает система:

- **Создает универсальные правила** с диапазонами значений
- **НЕ запоминает точные значения** (например, RSI=45)
- **Обобщает паттерны** для разных рыночных условий
- **Эволюционирует** правила (мутации, кроссовер)

### ❌ Что система НЕ делает:

- Не запоминает конкретные решения (RSI был 45 → buy)
- Не использует точные значения вместо диапазонов

### Параметры обучения

| Параметр | Значение | Описание |
|----------|----------|----------|
| **min_sample_size** | **10** | Минимум примеров для правила |
| **min_success_rate** | **50%** | Минимальная успешность правила |
| **generalization_threshold** | **0.6** | Порог обобщающей способности |
| **Текущий score** | **0.81** ✅ | Высокий уровень универсальности |

### Пример универсального правила:

**НЕ запоминает:**
```
"Если RSI = 45.3 И цена = $50123.45 → BUY"
```

**Создает правило:**
```
"Если RSI в диапазоне (35-55) И цена у поддержки И объем > среднего → BUY"
```

---

## 📊 ПРОЦЕСС ТОРГОВЛИ (ШАГ ЗА ШАГОМ)

### Цикл анализа (каждые 15 минут)

```
┌─────────────────────────────────────────┐
│ 1. Анализ общего тренда рынка           │
│    - BTC изменение                       │
│    - Топ-20 монет анализ                 │
│    - Определение: BULL/BEAR/NEUTRAL     │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│ 2. Умный выбор монет                    │
│    - BULL → 200 монет                   │
│    - BEAR → 100 монет                   │
│    - NEUTRAL → 145 монет ✅              │
│    - Фильтрация по объему               │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│ 3. Анализ каждой монеты                 │
│    Для каждой из 145 монет:            │
│    ├─ Мульти-таймфреймовый анализ (5 TF)│
│    ├─ 13 базовых индикаторов            │
│    ├─ Advanced Indicators (Ichi/Fib/S/R)│
│    ├─ Детекция манипуляций              │
│    ├─ OI анализ                         │
│    └─ Расчет уверенности                │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│ 4. Формирование сигнала                 │
│    ├─ Ensemble метод (все индикаторы)  │
│    ├─ MTF подтверждение                 │
│    ├─ Бонусы Advanced Indicators        │
│    ├─ ML бонусы                         │
│    └─ Итоговая уверенность              │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│ 5. Проверка условий                    │
│    ├─ Уверенность ≥ 65%?               │
│    ├─ Оценка стратегии ≥ 10?           │
│    ├─ Реалистичность OK?                │
│    ├─ Нет манипуляций?                  │
│    └─ Открытых позиций < 3?            │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│ 6. Открытие позиции (если ДА)          │
│    ├─ Размер: $25 (5 USDT × 5x)        │
│    ├─ Stop Loss: -20%                   │
│    ├─ Take Profit: 6 уровней            │
│    └─ Уведомление в Telegram            │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│ 7. Мониторинг позиции (каждую минуту)   │
│    ├─ Проверка TP уровней               │
│    ├─ Проверка SL                       │
│    ├─ Trailing Stop                     │
│    └─ Auto-Reversal при SL               │
└─────────────────────────────────────────┘
```

---

## 🎯 ИТОГОВАЯ ЛОГИКА

### Бот открывает сделку ТОЛЬКО если:

1. ✅ Уверенность ≥ 65% (базовый) или выше (адаптивная до 80%)
2. ✅ Оценка стратегии ≥ 10/20 баллов
3. ✅ Все 5 таймфреймов подтверждают (или большинство)
4. ✅ Нет манипуляций (реалистичный сигнал)
5. ✅ Сильный объем (volume spike)
6. ✅ Открытых позиций < 3
7. ✅ TP вероятности рассчитаны

### Бот закрывает позицию:

- **По TP**: Частично на каждом из 6 уровней (40%, 20%, 20%, 10%, 5%, 5%)
- **По SL**: Полностью при -20%
- **Trailing Stop**: Автоматически при движении в прибыль
- **Auto-reversal**: При SL + сильный противоположный сигнал (уверенность > 80%)

### Бот учится:

- ✅ Создает универсальные правила (диапазоны значений)
- ✅ НЕ запоминает точные значения
- ✅ Эволюционирует (мутации, кроссовер правил)
- ✅ Адаптируется под рыночные условия

---

## 💰 РАСЧЕТ ПРИБЫЛЬНОСТИ

### Гарантированный минимум на сделку

**При закрытии первых 3 TP:**
```
TP1 (40%): $25 × 40% × 4% = $0.40
TP2 (20%): $25 × 20% × 6% = $0.30  
TP3 (20%): $25 × 20% × 8% = $0.40
─────────────────────────────────
Итого: $1.10 (+4.4%)
```

**Минус комиссии (~$0.02):**  
**Чистая прибыль: ~$1.08 на сделку** ✅

**За 3 сделки (если все прибыльные):**
- Минимум: **+$3.24**
- Средняя: **+$3-5** (если закрываются TP4-TP6)

---

## 🎯 ТЕКУЩИЕ ПАРАМЕТРЫ НА СЕРВЕРЕ

- ✅ **Умный селектор**: 145 монет (NEUTRAL рынок)
- ✅ **MIN_CONFIDENCE**: 65% (базовый) ✅, адаптивный до 80%
- ✅ **Все библиотеки**: Установлены
- ✅ **База данных**: Работает
- ✅ **LLM анализатор**: Активен
- ✅ **Торговля**: Активирована

---

**🎯 Система полностью настроена и работает на сервере!**
