#!/bin/bash

# üì¶ –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º..."
ssh -i ~/.ssh/upcloud_trading_bot root@213.163.199.116 "echo '‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'"

# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
ssh -i ~/.ssh/upcloud_trading_bot root@213.163.199.116 "cd /root/trading_bot && \
    tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz *.py"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
scp -i ~/.ssh/upcloud_trading_bot \
    adaptive_parameters.py \
    adaptive_trading_system.py \
    test_adaptive_system.py \
    root@213.163.199.116:/root/trading_bot/

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
ssh -i ~/.ssh/upcloud_trading_bot root@213.163.199.116 "cd /root/trading_bot && \
    pip3 install -r requirements.txt"

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
ssh -i ~/.ssh/upcloud_trading_bot root@213.163.199.116 "cd /root/trading_bot && \
    python3 test_adaptive_system.py"
#!/usr/bin/env python3
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
ssh -i ~/.ssh/upcloud_trading_bot root@213.163.199.116 "cd /root/trading_bot && \
    cat test_results.json"

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
"""
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
==========================================
"""

import logging
from datetime import datetime, timedelta
import json
from adaptive_trading_system import AdaptiveTradingSystem
from adaptive_parameters import AdaptiveParameterSystem
import pandas as pd

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('system_test.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def load_market_data(days_back: int = 7) -> list:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ —Ä—ã–Ω–∫–∞
    pass

def calculate_pnl(trades: list) -> dict:
    """–†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏/—É–±—ã—Ç–∫–æ–≤"""
    total_profit = 0
    winning_trades = 0
    total_trades = len(trades)

    for trade in trades:
        if trade['profit'] > 0:
            winning_trades += 1
        total_profit += trade['profit']

    win_rate = (winning_trades / total_trades * 100) if total_trades > 0 else 0

    return {
        'total_profit': total_profit,
        'total_trades': total_trades,
        'winning_trades': winning_trades,
        'win_rate': win_rate
    }

def main():
    logger.info("üöÄ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
    trading_system = AdaptiveTradingSystem()

    # –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    market_data = load_market_data(days_back=7)

    if not market_data:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
        return

    trades = []

    # –ü—Ä–æ—Ö–æ–¥ –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º
    for data in market_data:
        result = trading_system.process_market_update(data)

        if result['action'] == 'enter_trade':
            trades.append({
                'timestamp': data['timestamp'],
                'entry_price': result['setup']['entry_price'],
                'position_size': result['setup']['position_size'],
                'take_profit': result['setup']['take_profit'],
                'stop_loss': result['setup']['stop_loss'],
                'leverage': result['setup']['leverage']
            })

    # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    performance = calculate_pnl(trades)

    logger.info("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    logger.info(f"–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {performance['total_trades']}")
    logger.info(f"–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {performance['winning_trades']}")
    logger.info(f"–í–∏–Ω—Ä–µ–π—Ç: {performance['win_rate']:.2f}%")
    logger.info(f"–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: ${performance['total_profit']:.2f}")

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    with open('test_results.json', 'w') as f:
        json.dump(performance, f, indent=2)

if __name__ == "__main__":
    main()
